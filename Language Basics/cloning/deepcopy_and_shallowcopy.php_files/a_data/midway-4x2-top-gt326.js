DISQUS.addBlocks("theme")(function(g){g.blocks.discoveryBoxHelp=function(n,b){var a=new g.Builder,d=DISQUS.extend({},n,b);with(d)return a.put('    <div class="alert">        <a class="close" data-action="discovery-help-close"/>\u00d7</a>        '),a.put(g.interpolate(gettext("Disqus helps you find new and interesting content, discussions and products. Some sponsors and ecommerce sites may pay us for these recommendations and links. %(learnMore)s or %(feedback)s."),{learnMore:g.renderBlock("learnMore"),
feedback:g.renderBlock("feedback")})),a.put("    </div>"),a.compile()};g.blocks.feedback=function(n,b){var a=new g.Builder,d=DISQUS.extend({},n,b);with(d)return a.put('<a href="https://www.surveymonkey.com/s/GHK872T" target="_blank">    '),a.put(gettext("give us feedback")),a.put("</a>"),a.compile()};g.blocks.relatedThread=function(n,b){var a=new g.Builder,d=DISQUS.extend({},n,b);with(d)return a.put('    <li class="discovery-unit">        <div class="main publisher-anchor-color">            <h3 title="'),
a.put((a.esc||function(a){return a})(thread.title)),a.put('">                <a class="title"                href="'),a.put((a.esc||function(a){return a})(thread.redirectUrl)),a.put('"                '),external&&a.put('target="_blank"'),a.put(">"),a.put(thread.title),a.put("</a>            </h3>            "),external&&thread.forum&&thread.forum.name&&(a.put('            <span class="extra eo">'),a.put((a.esc||function(a){return a})(thread.forum.name)),a.put("</span>            ")),a.put('            <span class="extra">            '),
thread.posts?(a.put("                "),thread.posts===1?(a.put("                    "),a.put(gettext("1 comment"))):(a.put("                    "),a.put(g.interpolate(gettext("%(numPosts)s comments"),{numPosts:thread.posts}))),a.put("                ")):(a.put("                "),a.put((a.esc||function(a){return a})(thread.brand))),a.put("            "),a.put("            </span>        </div>    </li>"),a.compile()};g.blocks.learnMore=function(n,b){var a=new g.Builder,d=DISQUS.extend({},n,b);with(d)return a.put('<a href="http://help.disqus.com/customer/portal/articles/666278-introducing-promoted-discovery-and-f-a-q-"   target="_blank">'),
a.put(gettext("Learn more")),a.put("</a>"),a.compile()};g.blocks.relatedThreads=function(n,b){var a=new g.Builder,d=DISQUS.extend({},n,b);with(d)return a.put('<div id="discovery-main" class="extra-links">    <div id="discovery-note" style="display:none;">        '),function(){var f={};g.extend(f,b);g.extend(f,{});a.put(g.renderBlock("discoveryBoxHelp",f))}(),a.put('    </div>    <div id="discovery-content-wrap">        <section id="discovery-external">            <header>                <div id="discovery-options">                    <span class="publisher-anchor-color"><a href="#" id="discovery-help" data-action="discovery-help">'),
a.put(gettext("What's this?")),a.put("</a></span>                    "),a.put("                </div>                <h2>"),a.put(gettext("Recommended For You")),a.put("</h2>            </header>            <ul>                "),a.put('            </ul>        </section>        <section id="discovery-internal">            <header>                <h2>'),a.put(g.interpolate(gettext("Also on %(forumName)s"),{forumName:g.renderBlock("forumName",forum)})),a.put("</h2>            </header>            <ul>                "),
a.put("            </ul>        </section>    </div></div>"),a.compile()};g.blocks.forumName=function(n,b){var a=new g.Builder,d=DISQUS.extend({},n,b);with(d)return a.put("<strong>"),a.put((a.esc||function(a){return a})(name)),a.put("</strong>"),a.compile()}});
(function(g){var n=g.document,b=g.DISQUS;b.registerActions=function(){b.define("discovery.collections",function(){var a=!1;return{load:function(d,f){var e=b.discovery.collections;if(a)return e;var c=Backbone.Collection.extend({initialize:function(a,e){this.mainThread=e.thread;this.limit=e.limit;this.variant=e.variant||{};this.external=e.external},fetch:function(a){var e={};e.data={thread:this.mainThread.get("id")};e.parse=!1;_.extend(e,a);Backbone.Collection.prototype.fetch.call(this,e)},addBandit:function(a){if((a=
a.response)&&a.bandit)this.bandit=a.bandit},getBanditJSON:_.memoize(function(){return b.JSON.stringify(this.bandit)}),makeRedirect:function(a,e,k){var c=a?"http://redirect.disqus.com/url":e.link+"#redirect",a={url:a,imp:b.juggler.impId,zone:k.external?"external_discovery":"internal_discovery",forum:this.mainThread.get("forum").id,source_thread_id:this.mainThread.id};this.variant.isExperiment&&_.extend(a,{variant:this.variant.name});e.advertisement_id?_(a).extend({zone:"promoted_discovery",advertisement_id:e.advertisement_id,
body_id:e.body_id}):_(a).extend({thread:e.id});this.bandit&&_.extend(a,{bandit:this.getBanditJSON()});return b.serialize(c,a)}});e.RelatedThreadCollection=c.extend({model:d.RelatedThread,url:b.api.getURL("discovery/listRelated.json"),parse:function(a){this.addBandit(a);var e=[],b=a.response||[];if(b.results)b=b.results;var c=f.log,r=this.mainThread.get("forum");c(this.url,"results (",b.length,"):",b,"ids:",_.pluck(b,"id"));for(var d=0,g=b.length;d<g&&e.length<this.limit;d++)if(a=b[d].thread||b[d],
a.id==this.mainThread.id)c("Thread",a.id,"is same as source thread.");else if(a.posts===0)c("Thread",a.id,"does not have any comments.");else if(a.title.indexOf("http://")===0)c("Thread",a.id,"has a title that starts with http.");else{a.score={score:b[d].score,k:b[d].k};if(a.signedUrl)a.redirectUrl=this.makeRedirect(a.signedUrl,a,{external:a.forum.id!=r.id});e.push(a)}c("Total results after pruning:",e.length);return e}});e.AdvertisementCollection=c.extend({model:d.Advertisement,url:b.api.getURL("discovery/listPromoted.json"),
external:!0,parse:function(a){this.addBandit(a);var e=[],b=a.response||[];if(b.results)b=b.results;f.log(this.url,"results (",b.length,"):",b,"ad_ids:",_.pluck(b,"advertisement_id"));for(var c=0,d=b.length;c<d&&e.length<this.limit;c++)a=b[c],a.redirectUrl=this.makeRedirect(a.signedUrl,a,{external:!0}),e.push(a);return e}});a=!0;return e}}});b.define("discovery",function(){return this.overwrites({init:function(a,d){function f(a,b,c,d,f){if(_.isNumber(d)&&a.length<d)return void e();a=new z({el:b,collection:a});
a.on("resize",function(){c.trigger("resize")});a.render(f||{});c.trigger("subViewRendered")}function e(e){e=e||{};if(!y){y=!0;var c=b.juggler.client("juggler");if(c){var d={major_version:"midway",internal_organic:j.length,external_organic:h.length,promoted:p.length,promoted_ids:b.JSON.stringify(p.pluck("advertisement_id")),display:!!e.display},f;if(v.bandit||p.bandit)f=_.extend({},v.bandit,p.bandit);f&&_.extend(d,{bandit:b.JSON.stringify(f)});a.isExperiment&&_.extend(d,{variant:o});q("Juggler init_discovery",
d);c.emit("init_discovery",d);g("dark_jester",function(){b.juggler.client("jester",!0).emit("init_discovery",d)})}}}var c=b.discovery.helpers,g=c.ifSwitch,q=c.log,k=a.switches,o=a.variant,r=a.session,t=a.forum,x=a.containerId;c.config(a.switches);var s=4,l=o.match(/(\d)x\d/);l&&(s=parseInt(l[1],10));var l=$("#"+a.loungeId),m=o.match(/^midway-4x2-top-gt(\d{1,3})$/);m&&(m=m[1],l.height()>m&&r.isAnonymous()&&t.settings.discoveryMax&&k.enabled("discovery_next:top_placement")?x+="-top":s=6);var t=b.discovery.models.load(),
l=b.discovery.collections.load(t,c),c=b.discovery.views.load(c),k=l.RelatedThreadCollection,z=c.RelatedThreadCollectionView,l=l.AdvertisementCollection,A=c.AdvertisementCollectionView,u=new t.Thread(_.extend(a.thread,{forum:a.forum})),s={thread:u,limit:s,variant:{isExperiment:!!a.isExperiment,name:o}},j=new k(null,s),h=new k(null,_.defaults({external:!0},s)),p=new l(null,_.defaults({external:!0},s)),t=[j,h,p];_.invoke(t,"on","error",e);var i=new c.MainView({el:n.getElementById(x)});i.$el.css({position:"absolute",
visibility:"hidden",display:"block"});i.$el.append(b.renderBlock(i.dtplBlock,{forum:u.get("forum"),variant:o,session:r.toJSON()}));r.on("change:canModerate",_.bind(i.renderHelp,i,r));_.invoke(t,"on","reset",function(){var a=0,e=0,b=!1;return function(c){b||(c.external?e+=c.length:a+=c.length,a<2||e<2||(b=!0,d(i)))}}());i.on("subViewRendered",_.after(2,function(){i.trigger("allSubviewsRendered");e({display:!0})}));var v=new k(null,_.defaults({limit:j.limit+h.limit},s));v.fetch({data:{thread:u.id,external:1,
limit:v.limit},success:function(a){if(a.length<2)return void e();var b=u.get("forum"),c;c=a.filter(function(a){return a.get("forum").id!=b.id});a=_.difference(a.models,c);j.reset(a.slice(0,j.limit)).each(function(a){a.collection=j});a=i.$el.find("#discovery-internal")[0];f(j,a,i,2,{start:0,limit:c.length});q("Internal organic",j.pluck("id"));h.reset(c.slice(0,h.limit)).each(function(a){a.collection=h});h.fetched=!0;q("External organic",h.pluck("id"))},error:e});p.fetch({data:{thread:u.id,limit:p.limit},
success:function(a){q("Promoted:",a.pluck("advertisement_id"));var b=i.$el.find("#discovery-external")[0],c=new A({el:b,collection:a}),d=function(){h.off("reset",d);if(j.length<2)return void e();var r=Math.min(j.length,a.limit),g=Math.min(j.limit,h.length+a.length);g>h.length&&f(j,i.$el.find("#discovery-internal")[0],i,2,{start:h.length,limit:g});h.length>0?(c.render({limit:r-1}),f(h,b,i,2-a.length,{limit:Math.max(r-a.length,1)})):c.render({limit:r});a.length>=2&&i.trigger("subViewRendered")};if(h.fetched)d();
else h.on("reset",d)},error:e});var y=!1}})});b.define("discovery.helpers",function(a,d){var f=null,e=!1,c=!1,g=function(){};a.console&&(g=function(){c&&(a.console.log.apply?a.console.log.apply(a.console,arguments):a.console.log(_.toArray(arguments).join(" ")))});var q=function(a){if(a===d)return c;c=!!a},k=function(a){if(a===d)return e;e=!!a},o=function(a,e,b){if(f)if(f.length)f.enabled(a)&&e();else{var c=function(){f.enabled(a)&&e();b&&f.off("reset",c)};return void f.on("reset",c)}};return{config:function(a){f=
a;k(!0);o("discovery_next:logging",function(){q(!0)})},allowLog:q,ifSwitch:o,log:g,allowLineTruncate:k,lineTruncate:function(c,d){function f(){return k.scrollHeight-k.offsetHeight>0.2*q}function g(){m.lastChild&&!_.contains(["...","\u2026"],m.lastChild.nodeValue)&&(j=m.appendChild(a.document.createTextNode(" "+o)),f()&&(m.removeChild(j),m.removeChild(m.lastChild),g()))}if(e){var l=b.logError||function(){};if(!c.closest("body").length)return void l("lineTruncate called on el not on DOM");if(c.text().length<
1)return void l("lineTruncated called on empty el");if(_.any(c.children(),function(a){return a.nodeType!==3}))return void l("lineTruncate called on non-flat el");var m=c[0],k=m;if(c.css("display")!=="block")for(;k.parentNode;)if(k=k.parentNode,$(k).css("display")==="block")break;var q=parseFloat(c.css("font-size"),10);if(f()){var d=d||{},l=d.lines||1,o=d.ellipsis,j,h=c.text();if(h.length){var p=c.width()/q,l=parseInt(p*l,10),h=h.split(/\s/),p=0;c.empty();for(var i=0,w=h.length;i<w;i++){p+=h[i].length+
1;if(p>=l)break;m.appendChild(n.createTextNode(" "+h[i]))}if(f()){do j=m.removeChild(m.lastChild);while(f())}else{do j=m.appendChild(n.createTextNode(" "+h[i++]));while(!f()&&i<w);m.removeChild(j)}o&&(_.isString(o)||(o="\u2026"),g())}}}}}});b.define("discovery.models",function(){var a=!1;return{load:function(){var d=b.discovery.models;if(a)return d;var f=d.Thread=Backbone.Model.extend({defaults:{author:null,category:null,createdAt:null,forum:null,identifiers:[],ipAddress:null,isClosed:!1,isDeleted:!1,
link:null,message:null,slug:null,title:null,userSubscription:!1,posts:0,reactions:0,likes:0,dislikes:0,userScore:0},url:b.api.getURL("threads/details"),parse:function(a){return a.response}});d.RelatedThread=f.extend({defaults:_.defaults({redirectUrl:null,topComment:null},f.prototype.defaults)});d.Advertisement=Backbone.Model.extend({idAttribute:"body_id",defaults:{brand:"",headline:"",text:"",url:"",advertisement_id:null,body_id:null,redirectUrl:null},get:function(a){if(a==="title")return this.get("headline");
return Backbone.Model.prototype.get.call(this,a)},toJSON:function(){var a=this.attributes;return{title:a.headline,brand:a.brand,redirectUrl:a.redirectUrl,link:a.url}}});a=!0;return d}}});b.define("discovery.views",function(){var a=!1;return{load:function(d){var f=b.discovery.views;if(a)return f;f.RelatedThreadView=Backbone.View.extend({events:{"click [data-redirect]":"swapLink"},dtplBlock:"relatedThread",swapLink:function(a){a=a.target||a.srcElement;a.tagName.toUpperCase()=="A"&&a.getAttribute("data-redirect")||
(a=$(a).closest("a[data-redirect]")[0]);var c=a;c.setAttribute("data-href",c.getAttribute("href"));c.setAttribute("href",c.getAttribute("data-redirect"));_.delay(function(){c.setAttribute("href",c.getAttribute("data-href"))},100)},renderAvatar:function(a){var c=this.$el.find("[data-role=discovery-avatar]");c.attr("src",a.avatar.cache);c.attr("alt",this.authorName(a));return this},authorName:function(a){return a.name||a.username},render:function(a){var a=a||{},c=a.parent,f=this.model.toJSON();if(!_.isObject(f.forum)&&
_.isString(f.forum))f.forum={name:f.forum};this.setElement(b.renderBlock(this.dtplBlock,{thread:f,external:!!a.external,variant:this.model.collection.variant.name}));c.append(this.$el);d.lineTruncate(this.$el.find("h3 a.title"),{lines:2,ellipsis:!0});this.$el.find("h3, .extra").css({display:"inline"});return this}});f.RelatedThreadCollectionView=Backbone.View.extend({resize:_.debounce(function(){this.trigger("resize")},500),render:function(a){var a=a||{},c=a.limit,b=_.isNumber(c),d=a.start,g=_.isNumber(d);
this.collection.each(function(a,e){b&&e>=c||g&&e<d||(new f.RelatedThreadView({model:a})).on("resize",this.resize,this).render({parent:this.$el.find("ul"),external:!!this.collection.external})},this);return this}});f.AdvertisementCollectionView=Backbone.View.extend({render:function(a){var a=a||{},b=a.limit,d=_.isNumber(b);this.collection.each(function(a,e){d&&e>=b||(new f.RelatedThreadView({model:a})).render({parent:this.$el.find("ul"),external:!0})},this);return this}});f.MainView=Backbone.View.extend({dtplBlock:"relatedThreads",
events:{"click [data-action=discovery-close]":"close","click [data-action=discovery-help]":"showHelp","click [data-action=discovery-help-close]":"closeHelp"},close:function(a){a.preventDefault();this.remove();this.trigger("resize",0)},showHelp:function(a){a.preventDefault();$(a.currentTarget).hide();this.$el.find("#discovery-note").show();this.trigger("resize")},closeHelp:function(a){a&&a.preventDefault();this.$el.find("#discovery-note").hide();this.trigger("resize")},renderHelp:function(a){this.closeHelp();
this.$el.find("[data-action=discovery-help]").show();this.$el.find("#discovery-note").html(b.renderBlock("discoveryBoxHelp",{session:a.toJSON()}))},render:function(){this.$el.css({position:"static",visibility:"visible"});return this}});a=!0;return f}}})};b.runThemeScript=b.registerActions})(this);